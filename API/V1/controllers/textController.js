// ייבוא מודל Text מקובץ `models/text.js`
const Text = require("../models/text");

// ייבוא geminiModel מקובץ `models/gemini.js`
const geminiModel = require("../models/gemini");

// יצוא אובייקט המכיל את הפונקציה `addText`
module.exports = {
  addText: async (req, res) => {
    try {
      // ////////////////////////////////////////////////////
      // בדיקת קיום גוף בקשה ו-prompt
      // אם חסר, החזר שגיאת 400 Bad Request עם הודעה
      // ////////////////////////////////////////////////////
      if (!req.body || !req.body.prompt) {
        return res.status(400).json({ error: "חסר prompt בגוף הבקשה" });
      }

      // ////////////////////////////////////////////////////
      // שליפת prompt מגוף הבקשה
      // ////////////////////////////////////////////////////
      const prompt = req.body.prompt;

      // ////////////////////////////////////////////////////
      // יצירת תוכן באמצעות geminiModel ופונקציית `generateContent`
      // קבלת תגובה
      // ////////////////////////////////////////////////////
      const result = await geminiModel.generateContent(prompt);
      const response = result.response;

      // ////////////////////////////////////////////////////
      // יצירת אובייקט Text חדש עם prompt ותשובה (טקסט מהתגובה)
      // ////////////////////////////////////////////////////
      const text = new Text({
        prompt,
        answer: response.text(),
      });

      // ////////////////////////////////////////////////////
      // שמירת מסמך טקסט חדש במסד הנתונים
      // קבלת מזהה טקסט
      // ////////////////////////////////////////////////////
      await text.save();

      // ////////////////////////////////////////////////////
      // שליחת טקסט שנוצר ומזהה טקסט שנשמר בתגובה
      // ////////////////////////////////////////////////////
      res.json({ text: response.text(), id: text._id });
    } catch (error) {
      // ////////////////////////////////////////////////////
      // טיפול בשגיאות: רישום שגיאה ושליחת 500 Internal Server Error
      // ////////////////////////////////////////////////////
      console.error(error);
      res.status(500).json({ error: "שגיאה ביצירת תוכן" });
    }
  },
};
